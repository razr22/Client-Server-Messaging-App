/*
 * @authors: Zain Quraishi
 * @date: 2018-06-29
 * @filename: ChatWindowUI.java
 * @description: Main client-side chat window. Processes user input, updates UI, sends and receives information to server.
*/

package Client;

import javax.swing.*;

import HelperClasses.Block;
import HelperClasses.Data;
import HelperClasses.TransferData;

import java.awt.*;
import java.awt.event.*;
import java.io.IOException;
import java.net.Socket;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;

@SuppressWarnings("serial")
public class ChatWindowUI extends JFrame
{
JPanel panel;
JPanel panel1;
JTextArea textField;
JTextArea textArea;
JButton exit;
boolean typing;
private String timeStamp;
protected static String convName;
private static ArrayList<Block> convLog;
private String uid;
protected static Socket windowsocket; 
protected int first = 0;

    public ChatWindowUI(Socket socket, String UID, String convName, ArrayList<Block> convLog){
    	ChatWindowUI.windowsocket = socket;
        this.uid = UID;	
    	ChatWindowUI.convName = convName;
        ChatWindowUI.convLog = convLog;
        generateChat(ChatWindowUI.convName, ChatWindowUI.convLog);
    }
   
    //retrieve message history before creating chat
    
    private void generateChat(String convName, ArrayList<Block> convLog){
    	 textField = new JTextArea();
		 textField.addFocusListener(new FocusListener() {
		     @Override
		     public void focusGained(FocusEvent e) {
		     	if (textField.getText().equals("Enter Message...") && textField.hasFocus()) {textField.setText("");}            	
		     }
		     @Override
		     public void focusLost(FocusEvent e) {
		     }
		 });
		
		 textField.addKeyListener(new KeyAdapter(){
		     public void keyPressed(KeyEvent key){
		     	if(key.getKeyCode()==KeyEvent.VK_ENTER && !textField.getText().equals("Enter Message...") && !textField.getText().isEmpty()) {
		 		try {
					logMessage(textField.getText());
				} catch (IOException e) {
					e.printStackTrace();
				}
		 	}
		 }
		
		 public void keyReleased(KeyEvent key){
		     if(key.getKeyCode()==KeyEvent.VK_ENTER && !textField.getText().equals("Enter Message...") && !textField.getText().isEmpty()) {
		    	 textField.setText("");
		     	}
		     }
		 });
		
	     exit = new JButton("Exit");
		 exit.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				try {
					windowsocket.close();
				} catch (IOException e1) {
					e1.printStackTrace();
				}
				dispose();
			}
		 });
         
        setTitle("WutsGud - " + convName);

        //CREATE TEXT ENTRY FIELD
        panel = new JPanel();
        panel.setLayout(new GridLayout(2,1));

        textField.setLineWrap(true);
        
        textField.setText("Enter Message...");
        panel.add(textField);
      
       // button.setMaximumSize(new Dimension(40,20));
        panel.add(exit, BorderLayout.SOUTH);
        add(panel,BorderLayout.SOUTH);
         
        //CREATE MESSAGE VIEWING SPACE
        textArea=new JTextArea();
        textArea.setBackground(Color.LIGHT_GRAY);
        textArea.setForeground(Color.BLUE);
        //textArea.setPreferredSize(new Dimension(350,400));
        textArea.setEditable(false);
       
        // Set some margin, for the text
        textArea.setMargin(new Insets(7,7,7,7));
        
        //POPULATE MESSAGES IN WINDOW
        //readHistory(textArea, convLog);
        if (convLog.size() > 1) {
        	textArea.append(convLog.get(0).data.getMessage() + "\n");
	        for (int i = 1; i < convLog.size(); i++) {
	        	String out = convLog.get(i).data.getUserID() +  " [" + convLog.get(i).data.getTimeStamp() + "]: " + convLog.get(i).data.getMessage();
	        	textArea.append(out + "\n");
	        }
        }
        else textArea.append(convLog.get(0).data.getMessage() + "\n");
        JScrollPane scroll = new JScrollPane(textArea);
        add(scroll);
       
        //FRAME INFO
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setResizable(false);
        //pack();
        setSize(350,400);
        setLocationRelativeTo(null);
        setVisible(true);
    }
    
    //USER HITS ENTER
    private void logMessage(String text) throws IOException{
        // If text is empty return
        if(text.trim().isEmpty()) return;

        timeStamp = new SimpleDateFormat("hh:mm:ss a").format(new Date());
        String out = uid +  " [" + timeStamp + "]: " + text;
        textArea.append(out + "\n");
        
        convLog.add(new Block(new Data(uid,text,timeStamp), convLog.get(convLog.size()-1).getCurrentHash()));
        
        TransferData.writeToFile(convLog, convName);
        
        Socket temp = windowsocket;
        first = TransferData.sendFile(convName, convLog, first, temp);
    }
}